<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Topic References :: DDM Documentation</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/ddl_favicon_black.svg" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div>
        <a class="navbar-item" href="../.."><img src="../../_/img/DDM_Logo_Weiss.svg" height="50px"></a>
      </div>
      <div class="navbar-slogan">
        <a class="navbar-item" href="../..">Data Donation Module Documentation</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ddm" data-version="develop">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">DDM</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="for_researchers.html">For Researchers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="for_admins.html">For System Administrators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="for_developers.html">For Developers</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="topic_references.html">Topic References</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="issues.html">Reporting Issues and Getting Help</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">DDM</span>
    <span class="version">develop</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../main/index.html">DDM</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../main/index.html">main</a>
        </li>
        <li class="version is-current">
          <a href="index.html">develop</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../main/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">DDM</a></li>
    <li><a href="topic_references.html">Topic References</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">develop</button>
  <div class="version-menu">
    <a class="version" href="../main/topic_references.html">main</a>
    <a class="version is-current" href="topic_references.html">develop</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/uzh/ddm/edit/develop/docs/modules/ROOT/pages/topic_references.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Topic References</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section covers a range of different topics.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_customizing_admin_templates"><a class="anchor" href="#_customizing_admin_templates"></a>Customizing Admin Templates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default admin templates include a minimalistic header and footer that do not integrate any actions related to
a researchers user account because authentication is handled by the main website (see <a href="#_user_authentication">User Authentication</a>).</p>
</div>
<div class="paragraph">
<p>However, for your own project you may wish to replace the default header and/or footer within the admin interface
to include your own branding and provide your users with some account management options such as a logout button.
This can be done by using Django&#8217;s template inheritance.</p>
</div>
<div class="paragraph">
<p>In your application create a new html template <code>your_application/templates/ddm/admin/base.html</code>. In this file,
you can overwrite the header and/or footer as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">{% extends "ddm/admin/base.html" %}

{% block extrahead %}
    &lt;!-- If you wish, you can integrate custom css files, favicon etc. here --&gt;
{% endblock %}

{% block header %}
&lt;div&gt;
    &lt;!-- Your Custom Header HTML --&gt;
&lt;/div&gt;
{% endblock %}

{% block footer %}
&lt;div&gt;
    &lt;!-- Your Custom Footer HTML --&gt;
&lt;/div&gt;
{% endblock %}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_encryption"><a class="anchor" href="#_encryption"></a>Encryption</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This pages aims to describe what types of encryption should be used by the system hosting this module and what is implemented in this module.</p>
</div>
<div class="sect2">
<h3 id="_encryption_in_transit_and_at_rest"><a class="anchor" href="#_encryption_in_transit_and_at_rest"></a>Encryption in transit and at rest</h3>
<div class="sect3">
<h4 id="_encryption_in_transit"><a class="anchor" href="#_encryption_in_transit"></a>Encryption in transit</h4>
<div class="paragraph">
<p>It is site-level responsibility to setup encryption in transit, like SSL/TLS for all communication between clients and the server.
For some hints on how this should be setup, start with the <a href="https://docs.djangoproject.com/en/4.0/topics/security/#ssl-https&gt;">Django docs</a>.
We minimize the amount of potential data that is processed on the server, by doing most of the filtering client-side.
Do take into account that ideally the connection from system to the database is secured as well, and that the database is stored on an encrypted system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_encryption_at_rest"><a class="anchor" href="#_encryption_at_rest"></a>Encryption at rest</h4>
<div class="paragraph">
<p>The module stores all data in encrypted fields in the database, the encryption/decryption procedure is described below.
Each project has a unique <code>salt</code> that is generated when creating the project.
In the Django site settings, we use the <strong>SECRET_KEY</strong> as the default passphrase for encryption.
If a project is working with sensitive data, we recommend that a <strong>project specific password</strong> is set.
This password is only known by the person setting it and should not be shared.
A project specific password will limit the functionality of the module for a given project: it won&#8217;t be possible to create followup questions based on the data donation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_encryption_and_decryption_process"><a class="anchor" href="#_encryption_and_decryption_process"></a>Encryption and decryption process</h3>
<div class="sect3">
<h4 id="_steps"><a class="anchor" href="#_steps"></a>Steps</h4>
<div class="paragraph">
<p>We use a hybrid asymmetric/symmetric encryption approach, due to the size limitation of the pure asymmetric approach.
The following steps occur in the encryption process
- generate a public key and store it in the project (if none exists)
- generate a session key used for encrypting a single message
- encrypt the data symmetrically using the session key
- encrypt the session key using the public key asymmetrically
- store the encrypted data with the encrypted key as header</p>
</div>
<div class="paragraph">
<p>The following steps occur in the decryption process
- generate a private key
- get the desired encrypted data from the project
- decrypt the encrypted session key (header) asymmetrically using the private key
- decrypt the data using the decrypted session key symmetrically</p>
</div>
</div>
<div class="sect3">
<h4 id="_asymmetric_key_generation_and_process"><a class="anchor" href="#_asymmetric_key_generation_and_process"></a>Asymmetric Key Generation and process</h4>
<div class="paragraph">
<p>For encryption we only need the public key;
- Check if we have a public key that is saved for the project
- if not, we should have gotten a passphrase and a salt with which we can generate a public key.&#8201;&#8212;&#8201;generate the private key&#8201;&#8212;&#8201;derive the public key&#8201;&#8212;&#8201;save the public key for the project
- We then use <a href="https://tools.ietf.org/html/rfc8017">PKCS#1 OAEP</a> for the wrapping and OAEP padding.</p>
</div>
<div class="paragraph">
<p>For decryption we need the private key;
- Using the supplied passphrase and salt, we generate a 128bit <a href="https://en.wikipedia.org/wiki/HMAC">HMAC</a> digest, which we use to populate a pseudo-random number generator.
- This random number generator is used to generate our <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA</a> key.
- We then use <a href="https://tools.ietf.org/html/rfc8017">PKCS#1 OAEP</a> for wrapping the OAEP padding.</p>
</div>
</div>
<div class="sect3">
<h4 id="_symmetric_key_generation_and_process"><a class="anchor" href="#_symmetric_key_generation_and_process"></a>Symmetric Key Generation and process</h4>
<div class="paragraph">
<p>There are significant limitations on the size of the data that can be encrypted using asymmetric algorithms and severe performance penalties.
This is why we combine this with symmetric encryption.
In our case we use <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard&gt;">AES</a> to encrypt the actual data.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_authentication"><a class="anchor" href="#_user_authentication"></a>User Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Data Donation Module uses the default Django user management to authenticate users.</p>
</div>
<div class="paragraph">
<p>For production use in the context of an academic institution we recommend implementing
authentication through an academic authentication infrastructure with OpenID Connect (OIDC) - see below.
In the case of single user instances, i.e., if DDM is installed and
deployed to only support one specific project, this step is not necessary.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
TODO: Explain creation of researcher profiles: 1. Login/Register through default authentication &#8594; 2. Create a DDM research profile associated to authenticated account &#8594; 3. redirect to ddm projects
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For authentication to work properly make sure you do the following in your main site:</p>
</div>
<div class="paragraph">
<p><strong>Define a login and logout view in urls.py:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">from django.contrib.auth import views as auth_views

urlpatterns = [
    # ...
    path('login/', auth_views.LoginView.as_view(template_name='myapp/login.html'), name='ddm-login'),
    path('logout/', auth_views.LogoutView.as_view(), name='ddm-logout'),
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Either, you define your own template ('myapp/login.html'), or you can reuse or customize the default DDM login template ('ddm/admin/auth/login.html' or 'ddm/admin/auth/login_oidc.html' if you use OIDC authentication).</p>
</div>
<div class="paragraph">
<p><strong>Define Proper redirect paths in your settings.py:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># Paths to redirect after login/logout
LOGIN_REDIRECT_URL = '/auth/researcher/'
LOGOUT_REDIRECT_URL = '/login/'</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_authentication_with_openid_connect_oidc"><a class="anchor" href="#_authentication_with_openid_connect_oidc"></a>Authentication With OpenID Connect (OIDC)</h3>
<div class="paragraph">
<p>We recommend using the package <a href="https://github.com/mozilla/mozilla-django-oidc">mozilla-django-oidc</a> for OIDC authentication.</p>
</div>
<div class="sect3">
<h4 id="_setup"><a class="anchor" href="#_setup"></a>Setup</h4>
<div class="paragraph">
<p>To enable OIDC authentication with mozilla-django-oidc, follow these steps (see also the official mozilla-django-oidc documentation):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup a client with an OpenID provider.</p>
</li>
<li>
<p>Install mozilla-django-oidc: <code>pip install mozilla-django-oidc</code></p>
</li>
<li>
<p>Next, adjust your settings.py. Add 'mozilla_django_oidc' to INSTALLED_APPS after 'django.contrib.auth'::</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">INSTALLED_APPS = (
    # ...
    'django.contrib.auth',
    'mozilla_django_oidc',
    # ...
)</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Add 'mozilla_django_oidc' authentication backend::</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">AUTHENTICATION_BACKENDS = (
    'mozilla_django_oidc.auth.OIDCAuthenticationBackend',
    # ...
)</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Add the following settings::</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># API values retrieved from OIDC provider:
OIDC_RP_CLIENT_ID = os.environ['OIDC_RP_CLIENT_ID']
OIDC_RP_CLIENT_SECRET = os.environ['OIDC_RP_CLIENT_SECRET']

# Look the following values up in your OIDC provider's documentation:
OIDC_OP_AUTHORIZATION_ENDPOINT = '&lt;URL of the OIDC OP authorization endpoint&gt;'
OIDC_OP_TOKEN_ENDPOINT = '&lt;URL of the OIDC OP token endpoint&gt;'
OIDC_OP_USER_ENDPOINT = '&lt;URL of the OIDC OP userinfo endpoint&gt;'</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Update urls.py::</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">urlpatterns = [
    # ...
    path('oidc/', include('mozilla_django_oidc.urls')),
    # ...
]</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Enable token renewal by adding the following to your middlewares in settings.py::</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">MIDDLEWARE = [
    # middleware involving session and authentication must come first
    # ...
    'mozilla_django_oidc.middleware.SessionRefresh',
    # ...
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exception_types"><a class="anchor" href="#_exception_types"></a>Exception Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page describes the implemented exceptions that are logged in a project&#8217;s exception log.</p>
</div>
<div class="sect2">
<h3 id="_exceptions_caught_on_client_side"><a class="anchor" href="#_exceptions_caught_on_client_side"></a>Exceptions Caught on Client Side</h3>
<div class="sect3">
<h4 id="_exceptions_during_data_donation_4xxx"><a class="anchor" href="#_exceptions_during_data_donation_4xxx"></a>Exceptions During Data Donation (4xxx)</h4>
<div class="sect4">
<h5 id="_file_messages_41xx"><a class="anchor" href="#_file_messages_41xx"></a>File Messages (41xx)</h5>
<div class="paragraph">
<p>File errors relate to exceptions raised during uploading and reading a file,
but before the read contents of a file are processed.</p>
</div>
<div class="paragraph">
<p><strong>4101: Not Zip</strong><br>
<em>Description:</em> Zip-container was expected as upload but another file type was selected (zip specific).<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4102: Corrupt Zip</strong><br>
<em>_Description:</em> The provided zip-container is corrupted (zip specific).<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4103: Encrypted Zip</strong><br>
<em>Description:</em> The provided zip-container is encrypted (zip specific).<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4104: Multiple Files</strong><br>
<em>Description:</em> Multiple files were selected.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4105: Wrong File Type</strong><br>
<em>Description:</em> The provided file does not match the expected file type.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4106: JSON Syntax Error</strong><br>
<em>Description:</em> The provided json file contains a syntax error.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4198: Generic Zip Error</strong><br>
<em>Description:</em> An unexpected exception occurred while processing the zip file (zip specific).<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4199: Generic File Error</strong><br>
<em>Description:</em> An unexpected exception occurred while processing a single file.<br>
<em>Exception Message:</em> TODO</p>
</div>
</div>
<div class="sect4">
<h5 id="_processing_messages_42xx"><a class="anchor" href="#_processing_messages_42xx"></a>Processing Messages (42xx)</h5>
<div class="paragraph">
<p><strong>4201: All Expected Fields Missing</strong><br>
<em>Description:</em> None of the entries in the supplied file did contain the expected fields as defined in the blueprint.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4202: Regex Not Matched</strong><br>
<em>Description:</em> The expected file did not exist.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4203: Entry Not Containing Expected Fields</strong><br>
<em>Description:</em> An entry did not contain one or more of the expected fields.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4204: All Entries Filtered Out</strong><br>
<em>Description:</em> All entries of an uploaded file were filtered out and therefore no data was extracted.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4205: All Entries Either Missing Expected Field or Filtered</strong><br>
<em>Description:</em> All entries of an uploaded file were either missing one or more expected fields or filtered out and therefore no data was extracted.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4206: Entry was filtered out</strong><br>
<em>Description:</em> A filter rule applied and the entry was deleted.<br>
<em>Exception Message:</em> TODO</p>
</div>
<div class="paragraph">
<p><strong>4299: Entry Not Containing Expected Fields</strong><br>
<em>Description:</em> An entry did not contain one or more of the expected fields.<br>
<em>Exception Message:</em> TODO</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exceptions_during_questionnaire_5xxx"><a class="anchor" href="#_exceptions_during_questionnaire_5xxx"></a>Exceptions During Questionnaire (5xxx)</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To be implemented
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_internationalization"><a class="anchor" href="#_internationalization"></a>Internationalization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The administration interface for researchers currently only supports English.
The participation interface currently supports English and German.</p>
</div>
<div class="sect2">
<h3 id="_language_detection"><a class="anchor" href="#_language_detection"></a>Language Detection</h3>
<div class="paragraph">
<p>The language in which the interface for participants is displayed is determined
by the default language of the participant&#8217;s browser.
If a language is not implemented for the participant interface, it is displayed
in English.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_support_for_new_languages"><a class="anchor" href="#_adding_support_for_new_languages"></a>Adding Support for new Languages</h3>
<div class="paragraph">
<p>To add support for a new language, new locales must be added at two locations:</p>
</div>
<div class="sect3">
<h4 id="_django_components"><a class="anchor" href="#_django_components"></a>Django Components</h4>
<div class="paragraph">
<p>Translations for the Django part of DDM are located at <code>/ddm/locale/</code>.</p>
</div>
<div class="paragraph">
<p>An extensive description of how translation is handled by Django can be found here:
<a href="https://docs.djangoproject.com/en/3.2/topics/i18n/translation/" class="bare">https://docs.djangoproject.com/en/3.2/topics/i18n/translation/</a></p>
</div>
<div class="paragraph">
<p>To create the translation files, first run <code>django-admin makemessages -l de</code> in
the <code>ddm</code> directory, where <code>de</code> is the locale name that you want to create.
This command creates or updates a file located at <code>ddm/locale/de/LC_MESSAGES/django.po</code>.
In this file, you can add your translations. Afterwards, run <code>django-admin compilemessages</code>
to create a <code>django.mo</code> file, which will be used by gettext for translation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_vue_components"><a class="anchor" href="#_vue_components"></a>Vue Components</h4>
<div class="paragraph">
<p>The translation files for the vue components are located at <code>/frontend/src/translations/</code>.</p>
</div>
<div class="paragraph">
<p>Here, support for a new language can be added by appending the respective locale name
as a first-level key to the json files and adding corresponding translations for all translation blocks.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_continuation"><a class="anchor" href="#_continuation"></a>Continuation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oftentimes, it can take some time between requesting a data takeout from a
platform and actually being able to download this takeout. Therefore, researchers
might want to provide their study participants with the possibility to pause their
participation and continue with the study as soon as they were able to download
their personal data takeout.</p>
</div>
<div class="paragraph">
<p>To enable this, DDM offers a continuation endpoint through which participants
can resume their participation. This endpoint is a URL containing the project
url identifier as well as the external participant ID passed as a URL parameter
<code>p</code>. This URL looks as follows:
<code><a href="https://your-domain.com/project-slug/continue?p=ExternalParticipantID" class="bare">https://your-domain.com/project-slug/continue?p=ExternalParticipantID</a></code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can display this continuation link in the instructions to your participants
by utilizing the Django templating functionality
(<a href="for_researchers.html#_participant_related_data" class="xref page">described here</a>)
as follows:
<code>https.//your-domain.com/project-slug/continue?p={{ participant.public_id }}</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="footer-content-bite"><a href="https://datadonation.uzh.ch"><img src="../../_/img/DataDonationLab_Logo_Schwarz.svg" height="50px"></a></div>
  <div class="footer-content-bite">Â© Data Donation Lab, 2023-present</div>
  <div class="footer-content-bite"><a href="https://github.com/uzh/ddm">DDM on GitHub</a></div>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
